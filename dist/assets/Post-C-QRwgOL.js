import{j as e,T as d,B as m,u as $,z as L,r as c,a as T,C as B,P as A,G as h,A as D}from"./index-CfyxJOqM.js";import{B as N}from"./BackButton-H5Jrz4yP.js";import z from"./ErrorPage-C7nTjVkm.js";function g({label:l,value:r}){return e.jsxs(d,{variant:"body2",sx:{color:"gray"},children:[l,":"," ",new Date(r).toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})]})}function G({comment:l,isLast:r}){return e.jsxs(m,{sx:{mb:2,pb:2,borderBottom:r?"none":"1px solid gray"},children:[e.jsxs(m,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsxs(d,{variant:"subtitle1",fontWeight:600,children:["@",l.author.username]}),e.jsx(d,{variant:"caption",sx:{color:"gray"},children:new Date(l.created_at).toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})})]}),e.jsx(d,{variant:"body1",sx:{whiteSpace:"pre-line",color:"#333"},children:l.body})]})}function H(){const l=$(),{postId:r}=L(),{token:f}=c.useContext(T),[x,i]=c.useState(null),[n,P]=c.useState(),[p,s]=c.useState({overlay:!0,edit:!1,publish:!1,delete:!1,next:!1,nextAll:!1}),[j,v]=c.useState([]),[E,C]=c.useState(0),[w,b]=c.useState(!0);c.useEffect(()=>{async function a(){s(t=>({...t,overlay:!0}));try{const t=await fetch(`https://blog-backend-production-16f8.up.railway.app/api/posts/${r}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`bearer ${f}`}}),o=await t.json();if(!t.ok){s(u=>({...u,overlay:!1})),i(o.message);return}P(o),v(o.comments),o.total_comments<5&&b(!1),o.total_comments>5&&(b(!0),C(5))}catch{i("Network error")}finally{s(t=>({...t,overlay:!1}))}}a()},[r,f]);async function _(){i(null),s(a=>({...a,publish:!0}));try{const a=await fetch(`https://blog-backend-production-16f8.up.railway.app/api/posts/${r}/publish`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`bearer ${f}`}}),t=await a.json();if(!a.ok){s(o=>({...o,publish:!1})),i(t.message);return}window.location.reload()}catch{i("Network error")}finally{s(a=>({...a,publish:!1}))}}async function S(){i(null),s(a=>({...a,delete:!0}));try{const a=await fetch(`https://blog-backend-production-16f8.up.railway.app/api/posts/${r}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`bearer ${f}`}}),t=await a.json();if(!a.ok){s(o=>({...o,delete:!1})),i(t.message);return}l("/")}catch{i("Network Error")}finally{s(a=>({...a,delete:!1}))}}async function k(a){a>5?s(t=>({...t,nextAll:!0})):s(t=>({...t,next:!0}));try{if(!w)return;const t=await fetch(`https://blog-backend-production-16f8.up.railway.app/api/posts/${r}/comments?limit=${a}&offset=${E}`),o=await t.json();if(!t.ok){s(u=>({...u,next:!1})),s(u=>({...u,nextAll:!1})),i(o.message||"Failed to get comments");return}v(u=>{const y=[...u,...o.comments];return n.total_comments>y.length&&(b(!0),C(y.length)),n.total_comments===y.length&&b(!1),y})}catch{i("Network error")}finally{s(t=>({...t,next:!1})),s(t=>({...t,nextAll:!1}))}}return p.overlay?e.jsx(B,{}):x?e.jsx(z,{message:x}):e.jsxs(m,{sx:{flexGrow:1,width:"100%",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",position:"relative"},children:[e.jsx(N,{onClick:()=>l("/")}),e.jsxs(A,{elevation:2,sx:{p:4,borderRadius:3,width:600,mt:6},children:[e.jsx(d,{variant:"h4",fontWeight:600,mb:2,children:n.title}),e.jsxs(d,{variant:"subtitle1",sx:{color:"gray",mb:1},children:["by ",e.jsxs("strong",{children:["@",n.author.username]})]}),e.jsx(g,{label:"Created",value:n.created_at}),n.updated_at!==n.created_at&&e.jsx(g,{label:"Updated",value:n.updated_at}),n.published?e.jsx(g,{label:"Published",value:n.published_at}):e.jsx(g,{label:"Not published"}),e.jsx(d,{variant:"body1",sx:{whiteSpace:"pre-line",mt:4,mb:4},children:n.body}),e.jsxs(m,{sx:{display:"flex",gap:1},children:[e.jsx(h,{name:"Edit",onClick:()=>l(`/${r}/edit`)}),!n.published&&e.jsx(h,{name:"Publish",disabled:p.publish,onClick:_}),e.jsx(h,{name:"Delete",disabled:p.delete,onClick:S})]}),x&&e.jsx(D,{type:"error",children:x})]}),j.length>0&&e.jsxs(A,{elevation:2,sx:{p:4,borderRadius:3,my:6,width:600},children:[e.jsx(d,{variant:"h5",fontWeight:600,mb:2,children:"Comments:"}),j.map((a,t)=>e.jsx(G,{comment:a,isLast:t===j.length-1},a.id)),e.jsxs(m,{sx:{display:"flex",gap:2,mt:2},children:[w&&e.jsx(h,{name:"Load next 5",disabled:p.next,onClick:()=>k(5)}),w&&e.jsx(h,{name:"Load all comments",disabled:p.nextAll,onClick:()=>k(n.total_comments)})]})]})]})}export{H as default};
